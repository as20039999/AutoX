# 第三方库修改记录 (Third-party Modifications)

为了确保项目的极致性能和稳定性，我们对 `third_party/` 目录下的第三方库进行了深度定制。本文件记录了这些修改，以便在未来升级库版本时能够快速恢复这些优化。

## 1. Ultralytics (YOLOv8/v11)

**目录**: `third_party/ultralytics`
**安装方式**: 源码集成 (`pip install -e ./third_party/ultralytics`)

### 修改列表：

#### 1.1 强制 NMS 在 CPU 上运行 (CPU-Bound NMS Patch)
- **文件**: [nms.py](file:///d:/Dev/Projects/AS/AutoX/third_party/ultralytics/ultralytics/utils/nms.py)
- **位置**: `non_max_suppression` 函数开始处 (约第 64 行)
- **修改内容**:
  ```python
  # [AutoX Fix] Force NMS on CPU to avoid CUDA driver hangs during concurrent DDA capture
  # This prevents the "A. Inference" freeze when GPU is under load
  if prediction.device.type != 'cpu':
      prediction = prediction.cpu()
  ```
- **目的**: 在启用 DDA (Desktop Duplication API) 高速采集时，如果 NMS 也在 GPU 上运行，高负载下极易导致 CUDA 驱动挂起或推理线程卡死。强制 NMS 在 CPU 上运行可以显著提升系统的整体稳定性，且对于少量目标的 NMS 性能损耗几乎可以忽略。

#### 1.2 TensorRT 异步推理优化 (TensorRT Async Inference Patch)
- **文件**: [autobackend.py](file:///d:/Dev/Projects/AS/AutoX/third_party/ultralytics/ultralytics/nn/autobackend.py)
- **位置**: `AutoBackend.forward` 函数中的 TensorRT 推理部分 (约第 787 行)
- **修改内容**:
  ```python
  # Fix: Use async execution to avoid inference thread hanging on Windows
  # TensorRT 8.5+ uses execute_async_v2, older versions use enqueue_v2
  binding_addrs = list(self.binding_addrs.values())
  stream = torch.cuda.current_stream().cuda_stream
  
  # Fix: Try async execution first using try-except to handle potential hasattr issues or version discrepancies
  try:
      self.context.execute_async_v2(binding_addrs, stream_handle=stream)
  except (AttributeError, TypeError):
      try:
          self.context.enqueue_v2(binding_addrs, stream_handle=stream)
      except (AttributeError, TypeError):
          # Fallback to sync execution (prone to freezing on Windows)
          # ...
          self.context.execute_v2(binding_addrs)
  ```
- **目的**: 解决 Windows 平台上 TensorRT 同步推理 (`execute_v2`) 可能导致推理线程假死的问题。通过引入 `execute_async_v2` 并配合 CUDA Stream，确保了推理过程的非阻塞性，极大提升了 GUI 的响应速度和采集推理的并行效率。

#### 1.3 PyTorch 2.9 版本兼容性支持 (PyTorch 2.9 Compatibility Patch)
- **文件**: [checks.py](file:///d:/Dev/Projects/AS/AutoX/third_party/ultralytics/ultralytics/utils/checks.py) (约 L505), [torch_utils.py](file:///d:/Dev/Projects/AS/AutoX/third_party/ultralytics/ultralytics/utils/torch_utils.py) (约 L48)
- **修改内容**:
  - 在 `checks.py` 的 `compatibility_table` 中手动添加了 `"2.9": ["0.24"]`。
  - 在 `torch_utils.py` 中添加了 `TORCH_2_9 = check_version(TORCH_VERSION, "2.9.0")` 定义。
- **目的**: 由于本项目使用了最新的 `torch==2.9.1+cu128`，官方 Ultralytics 源码尚未完全适配该版本。通过手动添加版本定义和兼容性表，消除了运行时的版本警告，并确保了相关底层逻辑（如 autocast 等）在最新 PyTorch 版本下的正确执行。

---

## 2. 修改建议与规范

1. **注释规范**: 所有在第三方库中进行的修改，必须以 `# [AutoX Fix]` 或 `# [AutoX Modification]` 开头，并简述修改原因。
2. **升级流程**:
   - 在升级第三方库前，先备份本记录。
   - 升级后，搜索项目中的 `[AutoX` 关键字。
   - 确认修改是否仍需保留，并手动迁移到新版本代码中。
3. **隔离原则**: 尽量通过 `monkey patch` 或子类化的方式在 `src/` 目录下进行扩展，仅在无法通过外部扩展实现性能目标时才直接修改 `third_party` 源码。
