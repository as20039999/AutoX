# AutoX 开发过程记录

## 2026-01-14 项目初始化与方案讨论

### 1. 需求分析与方案确立
- **平台锁定**：确立项目仅立足于 Windows 平台，移除 Android 兼容性设计以追求极致性能。
- **技术栈选型**：
    - **语言**：切换至 Python 3.11.9 (3.11 系列的最新成熟版本，确保最佳性能与稳定性)。
    - **推理**：YOLOv8 + TensorRT (针对 NVIDIA GPU 优化)。
    - **采集**：首选 DDA (Desktop Duplication API)，备选 WGC。
    - **模拟**：基于 `SendInput` 自研封装，预留驱动级接口。
    - **UI**：PySide6 (Qt for Python)。
    - **自包含性**：程序需完全自包含，用户端零依赖。

### 2. 安全机制设计
- **授权**：确立“一机一码”全离线授权方案，通过硬件指纹绑定。
- **防护**：采用 PyArmor (混淆) + Nuitka (编译) + VMProtect (加壳) 的多层防护体系。
- **时间校验**：引入本地加密运行日志与防回滚机制。

### 3. 文档更新
- 完成了 [项目介绍.md](file:///d:/Dev/Projects/AS/AutoX/docs/%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D.md) 的需求细化。
- 编写并完善了 [技术方案.md](file:///d:/Dev/Projects/AS/AutoX/docs/%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88.md)。

### 4. 环境与依赖清理
- **移除废弃依赖**：
    - 彻底移除了 `onnx` 和 `onnxruntime-gpu` 等 TensorRT 转换所需的中间库。
    - 清理了 `yolo_inference.py` 中过时的 TensorRT 注释与冗余导入。
- **依赖锁定**：
    - 明确了 `torch==2.9.1+cu128` 和 `torchvision==0.24.1+cu128` 作为核心计算后端。
    - 将 `ultralytics` 切换为本地源码安装模式 (`-e ./third_party/ultralytics`)。
- **文件清理**：
    - 检查并确认根目录下无冗余的 `.engine` 或 `.onnx` 临时文件。

### 5. 行为模拟模块开发
- **抽象设计**：定义 `AbstractInput` 基类，解耦逻辑层与底层驱动。
- **Win32 实现**：利用 `ctypes` 直接调用 `user32.dll` 中的 `SendInput` 和 `mouse_event`，确保高频操作下的稳定性与低延迟。
- **扩展性**：通过工厂模式 `create_input` 预留了驱动级硬件（如 KMBox）的接入位置。

### 6. 项目结构初始化
- **目录规划与创建**：
    - 建立了符合模块化设计的目录结构（`src/`, `assets/`, `configs/`, `models/`, `tests/`, `tools/`）。
    - 初始化了 `src/` 下各核心子模块（`capture`, `inference`, `input`, `gui`, `security`, `utils`）及其 `__init__.py` 文件。
    - 创建了程序入口文件 `src/main.py`。

### 6. 图像采集模块开发
- **抽象基类设计**：
    - 在 [base.py](file:///d:/Dev/Projects/AS/AutoX/src/capture/base.py) 中定义了 `AbstractCapture` 基类，确立了 `start`, `stop`, `get_frame` 的标准接口。
- **高性能 DDA 实现**：
    - 在 [dda_capture.py](file:///d:/Dev/Projects/AS/AutoX/src/capture/dda_capture.py) 中接入了 `dxcam` 库，实现了真正的 Desktop Duplication API (DDA) 采集，支持 GPU 零拷贝读取和高 FPS 输出。
- **容错与备选方案**：
    - 实现了 `MSSCapture` 作为 DDA 失败或不支持环境下的备选方案。
    - 在 `__init__.py` 中实现了工厂方法 `create_capture`，支持自动降级逻辑。

### 3. AI 推理模块开发
- **核心逻辑**：实现 `YOLOInference` 类，封装 Ultralytics YOLOv8。
- **方案调整**：
    - **移除 TensorRT**：考虑到分发便利性及用户自定义模型的加载速度，决定弃用 TensorRT 方案。
    - **PyTorch 原生推理**：直接加载 `.pt` 文件，支持 CUDA 硬件加速。
    - **源码集成 Ultralytics**：
        - 放弃 `pip` 远程安装，改为在 `third_party/ultralytics` 目录下通过源码安装 (`-e .`)。
        - 目的：实现对推理引擎的深度定制，支持未来可能的去 PyTorch 化改造或 NMS 算法优化。
    - **FP16 加速**：在 GPU 模式下默认开启 FP16 半精度推理。

### 7. 安全防护模块开发
- **硬件指纹提取**：
    - 在 [hardware.py](file:///d:/Dev/Projects/AS/AutoX/src/security/hardware.py) 中实现，提取 CPU ID、硬盘序列号、主板序列号。
    - 生成唯一的 Machine ID (SHA256)，确立“一机一码”基础。
- **授权校验逻辑**：
    - 在 [license.py](file:///d:/Dev/Projects/AS/AutoX/src/security/license.py) 中实现基于签名机制的离线授权。
    - 支持有效期校验与机器码匹配校验。
    - 预留了加密盐值混淆，增加破解难度。
- **HWID 命令修复**：由于 `wmic` 在新版 Windows 中弃用，已切换为 PowerShell `Get-CimInstance` 方案。

### 8. 核心控制模块开发
- **多线程架构设计**：
    - 在 [controller.py](file:///d:/Dev/Projects/AS/AutoX/src/core/controller.py) 中实现了 `AutoXController`。
    - 采用“生产者-消费者”模式：采集线程负责抓图，推理线程负责 AI 识别并驱动输入。
- **性能优化**：
    - 使用 `queue.Queue(maxsize=1)` 确保推理模块始终处理“最新鲜”的图像，将端到端延迟降至最低。
- **入口集成**：
    - 完成了 [main.py](file:///d:/Dev/Projects/AS/AutoX/src/main.py) 的编写，集成的授权检查与核心控制器的生命周期管理。
    - **显示逻辑优化**：为了解决 OpenCV 在多线程环境下的窗口稳定性问题（防止出现多个窗口或无响应），将所有 `imshow` 逻辑统一移至主线程。

### 9. GUI 界面与配置管理开发
- **配置系统实现**：
    - 编写了 [config.py](file:///d:/Dev/Projects/AS/AutoX/src/utils/config.py)，支持 JSON 格式的配置持久化。
    - 实现了配置的深度合并，确保新增配置项时不会破坏旧配置。
- **现代 UI 设计**：
    - 采用 PySide6 开发，应用了现代暗黑风格的 QSS 样式表 [styles.py](file:///d:/Dev/Projects/AS/AutoX/src/gui/styles.py)。
    - 界面布局简单直观：顶部状态监控，中部参数调整（置信度、平滑度），底部核心控制。
- **UI 与核心集成**：
    - 重构了 [main.py](file:///d:/Dev/Projects/AS/AutoX/src/main.py)，将 Qt 事件循环作为程序主循环。
    - 使用 `QTimer` 在主线程中安全地轮询调试画面队列，实现了 GUI 控制与 OpenCV 高速预览的完美并存。

## 2026-01-14 功能优化与工具链扩展

### 1. 递归采集问题修复
- **现象**：预览窗口采集自身导致“画中画”递归。
- **修复**：在 [main.py](file:///d:/Dev/Projects/AS/AutoX/src/main.py) 中引入 Windows 原生 API `SetWindowDisplayAffinity`，将预览窗口设置为 `WDA_EXCLUDEFROMCAPTURE`，使其对 DDA 和 MSS 采集不可见。

### 2. 人类行为模拟 (Human-Like Input)
- **平滑移动算法**：在 [win32_input.py](file:///d:/Dev/Projects/AS/AutoX/src/input/win32_input.py) 中实现了 `smooth_move_rel`。
    - **步进插值**：将瞬时移动分解为多个小步长，频率控制在 100Hz 左右。
    - **随机噪声**：在每一步移动中注入微小的随机偏移，模拟手部肌肉震颤，规避机械化检测。
- **UI 集成**：GUI 支持实时调整平滑度参数，并映射为移动耗时。

### 3. 多目标锁定逻辑优化
- **FOV 过滤**：引入 Field of View (FOV) 概念，仅锁定中心区域内的目标，防止大幅度拉枪。
- **距离优先排序**：在 [controller.py](file:///d:/Dev/Projects/AS/AutoX/src/core/controller.py) 中实现了基于欧几里得距离的目标排序，优先锁定离准星（屏幕中心）最近的目标。

### 4. 视频抽帧工具 (Video Dataset Tool)
- **后端实现**：开发了 [video_processor.py](file:///d:/Dev/Projects/AS/AutoX/src/utils/video_processor.py)，支持高效的视频帧提取。
- **前端集成**：在 GUI 中新增“数据集工具”选项卡，支持按总张数或时间间隔自动抽帧，并提供实时进度条反馈。

---
*后续操作将按此文档持续记录。*
