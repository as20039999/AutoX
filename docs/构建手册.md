# AutoX 打包与发布构建手册

本手册详细记录了 AutoX 项目的“薄壳”发布方案。该方案的核心思想是：**核心逻辑打包为独立 EXE (便捷、高效)，重型依赖外部化 (减小 EXE 体积，灵活维护)。**

---

## 一、 构建架构设计

AutoX 采用了一种**混合分发架构**：

1.  **AutoX.exe (核心层)**: 使用 PyInstaller 将 `launcher.py` 和 `src/` 源码打包为单文件 EXE。
    -   *为什么这么做？* 提升启动速度，且 EXE 体积较小。
2.  **python_runtime (环境层)**: 这是一个独立的、嵌入式的 Python 3.11 环境。
    -   *为什么这么做？* 用户无需安装 Python。所有重型库（Torch, TensorRT）都安装在这里，更新代码时无需让用户重新下载这 3GB 的环境。
3.  **init_env.bat (自动化层)**: 负责一键装配环境、安装驱动运行库。

---

## 二、 开发者构建步骤 (从源码到安装包)

作为开发者，当你完成代码修改准备发布时，请按顺序执行以下步骤：

### 1. 编译核心程序
运行 [build.py](file:///d:/Dev/Projects/AS/AutoX/build.py)：
```bash
python build.py
```
*   **执行动作**: 调用 PyInstaller，将源码打包。
*   **关键逻辑**: 脚本中配置了 `--exclude-module`，强制**排除**了 Torch、PySide6 等重型模块，防止它们被打包进 EXE 导致体积爆炸。
*   **产物**: `dist/AutoX.exe`。

### 2. 收集发布资源
运行 [release_tool.py](file:///d:/Dev/Projects/AS/AutoX/release_tool.py)：
```bash
python release_tool.py
```
*   **执行动作**: 自动化收集所有发布所需文件到 `release_staging/` 目录。
*   **关键逻辑**: 
    -   自动下载微软 **VC_redist.x64.exe**（24MB）。
    -   自动下载 **python_embed.zip**（10MB）。
    -   收集配置文件 `configs/`。
*   **目的**: 确保发布包是“全离线可用的”，用户初始化时无需联网下载 Python 核心。

### 3. 生成安装程序 (可选但推荐)
使用 **Inno Setup** 编译 [setup.iss](file:///d:/Dev/Projects/AS/AutoX/setup.iss)：
*   **执行动作**: 将 `release_staging/` 文件夹打包成一个标准的 `AutoX_Setup.exe`。
*   **产物**: 最终交付给用户的安装包。

---

## 三、 关键脚本原理解析

### 1. 智能启动器 ([launcher.py](file:///d:/Dev/Projects/AS/AutoX/launcher.py))
这是程序的“大脑”。当用户双击 `AutoX.exe` 时：
1.  它首先定位自己所在的物理路径。
2.  它会强制寻找并加载同级目录下的 `python_runtime`。
3.  它将内置的 `src/` 和本地的 `ultralytics/` 路径注入到 Python 搜索路径的最前面。
4.  **意义**: 解决了“打包后找不到库”或“误用系统 Python”的问题。

### 2. 初始化脚本 ([init_env.bat](file:///d:/Dev/Projects/AS/AutoX/init_env.bat))
这是部署阶段的“总调度”：
1.  **VC 库检测**: 自动静默安装 Visual C++ 运行库。
2.  **环境解压**: 将 `python_embed.zip` 解压为 `python_runtime`。
3.  **Pip 注入**: 为嵌入式 Python 动态安装 Pip 并配置 `._pth` 文件（这是嵌入式版最难处理的一步，已自动搞定）。
4.  **依赖安装**: 使用清华镜像源安装 `requirements_deploy.txt` 中的重型库。

---

## 四、 常见维护任务

### 如何更新依赖？
如果项目引入了新的第三方库（如 `requests`）：
1.  修改 [requirements_deploy.txt](file:///d:/Dev/Projects/AS/AutoX/requirements_deploy.txt)。
2.  重新运行 `python release_tool.py` 准备新包。
3.  用户覆盖安装后运行 `init_env.bat` 即可。

### 如何修改默认配置？
1.  修改 `configs/config.json`。
2.  这些文件会被 `release_tool.py` 自动抓取。

---

## 五、 注意事项
*   **编译器**: 运行 `build.py` 的机器必须安装有 Visual Studio 2022 (C++ 桌面开发工作负载)。
*   **网络**: `release_tool.py` 收集资源时需要网络；用户执行 `init_env.bat` 时也需要网络来下载 Torch (除非你手动将 Torch 的 whl 文件也包含进包中)。
